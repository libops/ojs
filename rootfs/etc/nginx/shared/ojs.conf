root /var/www/ojs;
index index.php;

error_log /dev/stderr;
access_log /dev/stdout combined;

error_log /dev/stderr;
access_log /dev/stdout combined;

# API rewrite with redirect
location ~ ^/api/v1(.*)$ {
    return 307 /index.php/api/v1$1;
}

# Main location block
location / {
    # Try to serve file directly, otherwise pass to index.php
    try_files $uri $uri/ /index.php/$uri?$query_string;
}

# PHP processing
location ~ \.php(/|$) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    if (!-f $document_root$fastcgi_script_name) {
        return 404;
    }

    fastcgi_pass unix:/var/run/php-fpm83/php-fpm83.sock;

    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    include fastcgi_params;
}

# Deny access to hidden files
location ~ /\. {
    deny all;
}
